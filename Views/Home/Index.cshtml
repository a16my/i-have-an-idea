@using BirFikrimVar.Models
@model IEnumerable<Post>

@{
    ViewData["Title"] = "Feed";
}

<div class="container mt-4">
    <h2 class="mb-4">📰 Feed</h2>

    <!-- 🔹 Show TempData Errors -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- 🔹 Create Post Form -->
    @if (User.Identity.IsAuthenticated)
    {
        <div class="card mb-4">
            <div class="card-body">
                <form asp-controller="Posts" asp-action="Create" method="post">
                    <div class="mb-3">
                        <input type="text" name="title" class="form-control" placeholder="Your Idea Title" required />
                    </div>
                    <div class="mb-3">
                        <textarea name="content" class="form-control" placeholder="Share your idea..." rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Idea</button>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <a asp-area="Identity" asp-page="/Account/Login">Login</a> or 
            <a asp-area="Identity" asp-page="/Account/Register">Register</a> to share your ideas.
        </div>
    }

    <!-- 🔹 Show Posts -->
    @foreach (var post in Model)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">@post.Title</h5>
                <p class="card-text">@post.Content</p>
                <small class="text-muted">
                    Posted by <strong>@post.User?.FullName</strong> on @post.CreatedAt.ToLocalTime().ToString("g")
                </small>

                <hr />

                <!-- Like Button -->
                <form asp-controller="Posts" asp-action="Like" asp-route-id="@post.Id" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        👍 Like (@post.Likes.Count)
                    </button>
                </form>

                <!-- Comment Count -->
                <span class="ms-3">💬 @post.Comments.Count comments</span>

                <!-- Comment Form -->
                @if (User.Identity.IsAuthenticated)
                {
                    <form asp-controller="Posts" asp-action="Comment" method="post" class="mt-3">
                        <input type="hidden" name="postId" value="@post.Id" />
                        <div class="input-group">
                            <input type="text" name="content" class="form-control" placeholder="Add a comment..." required />
                            <button type="submit" class="btn btn-secondary">Send</button>
                        </div>
                    </form>
                }

                <!-- Show Comments -->
                @if (post.Comments.Any())
                {
                    <ul class="list-group list-group-flush mt-3">
                        @foreach (var comment in post.Comments.OrderByDescending(c => c.CreatedAt))
                        {
                            <li class="list-group-item">
                                <strong>@comment.User?.FullName</strong>: @comment.Content
                                <br />
                                <small class="text-muted">@comment.CreatedAt.ToLocalTime().ToString("g")</small>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
    }
</div>